<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Practice Bharatanatyam mudras with real-time AI detection">
    <title>Live Detection - Mudra Academy</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/pages.css">

    <!-- MediaPipe Hands for client-side landmark detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.min.js"
        crossorigin="anonymous"></script>

    <!-- ONNX Runtime Web for ML inference -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.0/dist/ort.min.js"></script>

    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%238B2942' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='%23D4A84B' font-family='serif'%3EM%3C/text%3E%3C/svg%3E">

    <style>
        .detection-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: var(--spacing-xl);
            max-width: 1200px;
            margin: 0 auto;
        }

        .video-container {
            background: var(--color-dark);
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            aspect-ratio: 4/3;
        }

        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            display: none;
        }

        #landmarkCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
        }

        .video-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--color-dark);
            color: var(--color-light);
        }

        .video-placeholder svg {
            width: 64px;
            height: 64px;
            color: var(--color-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .video-placeholder h3 {
            font-family: var(--font-heading);
            margin-bottom: var(--spacing-sm);
        }

        .video-placeholder p {
            color: var(--color-gray);
        }

        .mudra-label {
            position: absolute;
            bottom: var(--spacing-md);
            left: var(--spacing-md);
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-light);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--color-light);
            z-index: 100;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-gray);
            border-top-color: var(--color-secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-md);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1rem;
            color: var(--color-secondary);
        }

        .controls {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-top: var(--spacing-lg);
        }

        .control-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-full);
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
        }

        .btn-start {
            background: var(--color-primary);
            color: var(--color-light);
        }

        .btn-start:hover {
            background: var(--color-primary-dark);
            box-shadow: var(--shadow-primary);
        }

        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #ef4444;
            color: var(--color-light);
        }

        .btn-stop:hover {
            background: #dc2626;
        }

        .btn-reset {
            background: var(--color-light);
            color: var(--color-dark);
            border: 2px solid var(--color-gray-light);
        }

        .btn-reset:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .sidebar-card {
            background: var(--color-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid rgba(139, 41, 66, 0.1);
        }

        .sidebar-card+.sidebar-card {
            margin-top: var(--spacing-lg);
        }

        .sidebar-card h3 {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            color: var(--color-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .sidebar-card h3 svg {
            width: 18px;
            height: 18px;
            color: var(--color-secondary);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-light-warm);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
        }

        .api-status.connected {
            background: #dcfce7;
            color: #166534;
        }

        .api-status.loading {
            background: #fef3c7;
            color: #92400e;
        }

        .api-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .current-mudra-display {
            text-align: center;
            padding: var(--spacing-lg) var(--spacing-md);
            background: linear-gradient(135deg, rgba(139, 41, 66, 0.08) 0%, rgba(212, 168, 75, 0.08) 100%);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-sm);
        }

        .current-mudra-display h4 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
            text-shadow: 1px 1px 2px rgba(139, 41, 66, 0.1);
            line-height: 1.1;
        }

        .current-mudra-display p {
            color: var(--color-gray);
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .stat-box {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--color-light-warm);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--color-gray);
            margin-top: var(--spacing-xs);
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--color-gray-light);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-abbr {
            width: 32px;
            height: 32px;
            background: var(--gradient-card);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--color-primary);
        }

        .history-info {
            flex: 1;
        }

        .history-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--color-gray);
        }

        .history-conf {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-secondary);
        }

        .empty-state {
            text-align: center;
            color: var(--color-gray);
            padding: var(--spacing-lg) 0;
            font-size: 0.9rem;
        }

        @media (max-width: 900px) {
            .detection-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar scrolled">
        <div class="container">
            <a href="#" onclick="history.back(); return false;" class="back-link"
                style="margin-right: 15px; display: flex; align-items: center; color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </a>
            <a href="../index.html" class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" />
                        <path d="M12 6v6l4 2" />
                    </svg>
                </div>
                <span class="logo-text">Mudra Academy</span>
            </a>
            <ul class="nav-links">
                <li><a href="../index.html#features">Features</a></li>
                <li><a href="../index.html#games">Games</a></li>
                <li><a href="library.html">Library</a></li>
            </ul>
            <div class="nav-cta">
                <a href="detection-mode.html" class="btn btn-primary">Live Detection</a>
            </div>
            <button class="mobile-menu-btn" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <section class="page-content section">
        <div class="container">
            <div class="detection-layout">
                <div>
                    <div class="video-container">
                        <video id="webcam" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                        <canvas id="landmarkCanvas"></canvas>
                        <div class="video-placeholder" id="placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path
                                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg>
                            <h3>Camera Ready</h3>
                            <p>Click Start to begin detection</p>
                        </div>
                        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                            <div class="loading-spinner"></div>
                            <div class="loading-text" id="loadingText">Loading models...</div>
                        </div>
                        <div class="mudra-label" id="mudraName" style="display:none;">--</div>
                    </div>
                    <div class="controls">
                        <button class="control-btn btn-start" id="startBtn" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3" />
                            </svg>
                            Start
                        </button>
                        <button class="control-btn btn-stop" id="stopBtn" style="display:none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="6" width="12" height="12" />
                            </svg>
                            Stop
                        </button>
                        <button class="control-btn btn-reset" id="resetBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10" />
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>
                <aside>
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            Current Mudra
                        </h3>
                        <div class="current-mudra-display">
                            <h4 id="currentName">--</h4>
                            <p id="currentMeaning">Waiting for detection</p>
                        </div>
                    </div>
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10" />
                                <line x1="12" y1="20" x2="12" y2="4" />
                                <line x1="6" y1="20" x2="6" y2="14" />
                            </svg>
                            Session
                        </h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="uniqueCount">0</div>
                                <div class="stat-label">Mudras</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="duration">0:00</div>
                                <div class="stat-label">Time</div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                            Detected Mudras
                        </h3>
                        <div class="history-list" id="historyList">
                            <div class="empty-state">No mudras detected yet</div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-simple">
                <a href="../index.html" class="footer-logo">
                    <span>Mudra Academy</span>
                </a>
                <nav class="footer-nav">
                    <a href="../index.html">Home</a>
                    <a href="library.html">Library</a>
                    <a href="detection-mode.html">Detection</a>
                    <a href="../index.html#games">Games</a>
                </nav>
                <p class="footer-copy">&copy; 2025 Mudra Academy. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <!-- Core Modules -->
    <script src="../js/mudra-constants.js"></script>
    <script src="../js/mudra-inference.js"></script>
    <script src="../js/mudra-detection.js"></script>

    <script>
        (function () {
            'use strict';

            // ============================================================
            // PERFORMANCE OPTIMIZATION CONFIGURATION
            // ============================================================
            const DETECT_INTERVAL_ACTIVE = 100;   // ~10 FPS when hand visible
            const DETECT_INTERVAL_IDLE = 200;     // ~5 FPS when no hand (saves CPU)
            const IDLE_THRESHOLD = 5;             // Frames without hand before going idle
            const STABLE_DETECTION_SLOWDOWN = 3;  // Slow down after stable detection

            // State
            let running = false;
            let modelsLoaded = false;
            let video, canvas, ctx, landmarkCanvas, landmarkCtx;
            let hands, camera;
            let sessionTimer, startTime;
            let uniqueMap = {}, lastMudra = null;
            let lastDetectTime = 0;
            let currentLandmarks = null;
            let prevLandmarks = null;
            let mudraFSM = null;

            // Performance optimization state
            let idleFrameCount = 0;
            let stableDetectionCount = 0;
            let currentDetectInterval = DETECT_INTERVAL_ACTIVE;

            // Hand landmark connections
            const HAND_CONNECTIONS = [
                [0, 1], [1, 2], [2, 3], [3, 4],
                [0, 5], [5, 6], [6, 7], [7, 8],
                [0, 9], [9, 10], [10, 11], [11, 12],
                [0, 13], [13, 14], [14, 15], [15, 16],
                [0, 17], [17, 18], [18, 19], [19, 20],
                [5, 9], [9, 13], [13, 17]
            ];

            // Mudra meanings
            const meanings = {
                'Pataka': 'Flag - Beginning, clouds',
                'Pataka Mudra': 'Flag - Beginning, clouds',
                'Tripataka': 'Three-part flag - Crown',
                'Tripataka Mudra': 'Three-part flag - Crown',
                'Tripathaka': 'Three-part flag - Crown',
                'Ardhapataka': 'Half flag - Leaves',
                'Ardhapataka Mudra': 'Half flag - Leaves',
                'Ardhapathaka': 'Half flag - Leaves',
                'Kartarimukha': 'Scissors - Separation',
                'Kartari Mukham Mudra': 'Scissors - Separation',
                'Katrimukha': 'Scissors - Separation',
                'Mayura': 'Peacock',
                'Mayura Mudra': 'Peacock',
                'Ardhachandra': 'Half moon',
                'Ardhachandran': 'Half moon',
                'Arala': 'Bent',
                'Arala Mudra': 'Bent',
                'Aralam': 'Bent',
                'Shukatunda': 'Parrot beak',
                'Shuka Tundam Mudra': 'Parrot beak',
                'Shukatundam': 'Parrot beak',
                'Musti': 'Fist',
                'Musthi Mudra': 'Fist',
                'Mushti': 'Fist',
                'Shikhara': 'Peak',
                'Shikharam Mudra': 'Peak',
                'Sikharam': 'Peak',
                'Kapittha': 'Elephant apple',
                'Kapith': 'Elephant apple',
                'Katakamukha': 'Bracelet opening',
                'Katakamukha_1': 'Bracelet opening',
                'Suchi': 'Needle',
                'Suchi Mudra': 'Needle',
                'Chandrakala': 'Moon digit',
                'Padmakosha': 'Lotus bud',
                'Sarpashirsha': 'Snake hood',
                'Sarpashirsha Mudra': 'Snake hood',
                'Sarpasirsha': 'Snake hood',
                'Mrigashirsha': 'Deer head',
                'Mrigasheersha Mudra': 'Deer head',
                'Mrigasirsha': 'Deer head',
                'Simhamukha': 'Lion face',
                'Simhamukha Mudra': 'Lion face',
                'Simhamukham': 'Lion face',
                'Kangula': 'Bell',
                'Kangulam': 'Bell',
                'Alapadma': 'Bloomed lotus',
                'Alapadmam': 'Bloomed lotus',
                'Chatura': 'Square',
                'Chatura Mudra': 'Square',
                'Chaturam': 'Square',
                'Bhramara': 'Bee',
                'Bramaram': 'Bee',
                'Hamsasya': 'Swan beak',
                'Hamsasya Mudra': 'Swan beak',
                'Hamsasyam': 'Swan beak',
                'Hamsapaksha': 'Swan wing',
                'Samdamsha': 'Pincers',
                'Mukula': 'Bud',
                'Mukulam': 'Bud',
                'Trishula': 'Trident',
                'Trishula Mudra': 'Trident',
                'Trishulam': 'Trident',
                'Tamarachudam': 'Lotus petal'
            };

            const $ = (id) => document.getElementById(id);

            // Initialize ONNX models
            async function initializeModels() {
                const loadingOverlay = $('loadingOverlay');
                const loadingText = $('loadingText');
                const startBtn = $('startBtn');

                loadingOverlay.style.display = 'flex';

                try {
                    loadingText.textContent = 'Loading AI...';

                    // Initialize only RF model (not YOLO - that's for double-hand)
                    const success = await window.MudraInference.initialize({ loadYolo: false, loadRF: true });

                    if (success) {
                        modelsLoaded = true;
                        startBtn.disabled = false;

                        // Initialize FSM
                        mudraFSM = new window.MudraDetection.MudraFSM();
                    } else {
                        throw new Error('Failed to load models');
                    }
                } catch (error) {
                    loadingText.textContent = 'Error loading models';
                    loadingText.style.color = '#ff4444';
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            // Draw landmarks on canvas
            function drawLandmarks(landmarks) {
                if (!landmarkCtx) return;

                const w = landmarkCanvas.width;
                const h = landmarkCanvas.height;

                landmarkCtx.clearRect(0, 0, w, h);

                if (!landmarks || landmarks.length < 21) return;

                // Draw connections
                landmarkCtx.strokeStyle = 'rgba(212, 168, 75, 0.8)';
                landmarkCtx.lineWidth = 3;
                landmarkCtx.lineCap = 'round';

                HAND_CONNECTIONS.forEach(([start, end]) => {
                    const startLm = landmarks[start];
                    const endLm = landmarks[end];
                    if (startLm && endLm) {
                        landmarkCtx.beginPath();
                        landmarkCtx.moveTo(startLm.x * w, startLm.y * h);
                        landmarkCtx.lineTo(endLm.x * w, endLm.y * h);
                        landmarkCtx.stroke();
                    }
                });

                // Draw landmark points
                landmarks.forEach((lm, index) => {
                    const x = lm.x * w;
                    const y = lm.y * h;

                    if (index === 0) {
                        // Wrist
                        landmarkCtx.fillStyle = '#8B2942';
                        landmarkCtx.beginPath();
                        landmarkCtx.arc(x, y, 4, 0, Math.PI * 2);
                        landmarkCtx.fill();
                        landmarkCtx.strokeStyle = '#fff';
                        landmarkCtx.lineWidth = 2;
                        landmarkCtx.stroke();
                    } else if ([4, 8, 12, 16, 20].includes(index)) {
                        // Fingertips
                        landmarkCtx.fillStyle = '#D4A84B';
                        landmarkCtx.beginPath();
                        landmarkCtx.arc(x, y, 4, 0, Math.PI * 2);
                        landmarkCtx.fill();
                        landmarkCtx.strokeStyle = '#fff';
                        landmarkCtx.lineWidth = 2;
                        landmarkCtx.stroke();
                    } else {
                        // Other joints
                        landmarkCtx.fillStyle = '#fff';
                        landmarkCtx.beginPath();
                        landmarkCtx.arc(x, y, 4, 0, Math.PI * 2);
                        landmarkCtx.fill();
                    }
                });
            }

            // MediaPipe results callback (OPTIMIZED with adaptive detection rate)
            function onResults(results) {
                if (!running) return;

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    currentLandmarks = results.multiHandLandmarks[0];
                    drawLandmarks(currentLandmarks);

                    // Hand detected - reset to active mode
                    idleFrameCount = 0;
                    currentDetectInterval = DETECT_INTERVAL_ACTIVE;
                } else {
                    currentLandmarks = null;
                    if (landmarkCtx) {
                        landmarkCtx.clearRect(0, 0, landmarkCanvas.width, landmarkCanvas.height);
                    }

                    // No hand - count idle frames and slow down detection
                    idleFrameCount++;
                    if (idleFrameCount > IDLE_THRESHOLD) {
                        currentDetectInterval = DETECT_INTERVAL_IDLE;
                    }
                }

                // Run detection (throttled with adaptive interval)
                const now = Date.now();
                if (now - lastDetectTime >= currentDetectInterval) {
                    lastDetectTime = now;
                    detectMudra();
                }
            }

            // Main detection function (pure JS, no server)
            async function detectMudra() {
                if (!running || !modelsLoaded || !mudraFSM) return;

                let candidateName = null;
                let candidateConf = 0;
                let candidateMethod = null;

                if (currentLandmarks && currentLandmarks.length >= 21) {
                    // Run hybrid detection (rules + ML)
                    const result = await window.MudraDetection.detectMudraHybrid(
                        currentLandmarks,
                        "Right",
                        prevLandmarks
                    );

                    if (result.mudraName && !["Unknown", "Stabilizing..."].includes(result.mudraName)) {
                        candidateName = result.mudraName;
                        candidateConf = result.confidence;
                        candidateMethod = result.method;
                    }

                    // Store for stability check
                    prevLandmarks = currentLandmarks.map(lm => ({
                        x: lm.x, y: lm.y, z: lm.z || 0
                    }));
                }

                // Update FSM
                const fsmResult = mudraFSM.update(
                    !!currentLandmarks,
                    candidateName,
                    candidateConf,
                    candidateMethod
                );

                // Update display
                show(fsmResult.displayName, fsmResult.displayConf, fsmResult.displayMethod);
            }

            function show(name, conf, method) {
                const label = $('mudraName');
                const currentName = $('currentName');
                const currentMeaning = $('currentMeaning');

                // Skip interim states
                if (!name || ['Unknown', 'Stabilizing...', 'Detecting...', 'Show mudra...', 'No hand detected'].includes(name)) {
                    label.textContent = name || '--';
                    label.style.color = '#fff';
                    currentName.textContent = '--';
                    currentMeaning.textContent = 'Waiting for detection';
                    return;
                }

                // Display detected mudra
                const displayName = name.replace(' Mudra', '');
                const confText = conf > 0 ? ` (${(conf * 100).toFixed(0)}%)` : '';

                label.textContent = displayName + confText;
                label.style.color = method === 'RULE' ? '#D4A84B' : '#4ADE80';

                currentName.textContent = displayName;
                currentMeaning.textContent = meanings[name] || meanings[displayName] || 'Traditional mudra';

                // Track unique mudras
                if (name !== lastMudra) {
                    lastMudra = name;
                    if (!uniqueMap[name]) {
                        uniqueMap[name] = true;
                        $('uniqueCount').textContent = Object.keys(uniqueMap).length;
                    }
                    addHistory(name, conf, method);
                }
            }

            function addHistory(name, conf, method) {
                const list = $('historyList');
                const empty = list.querySelector('.empty-state');
                if (empty) empty.remove();

                const displayName = name.replace(' Mudra', '');
                const abbr = displayName.substring(0, 2).toUpperCase();
                const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                <div class="history-abbr">${abbr}</div>
                <div class="history-info">
                    <div class="history-name">${displayName}</div>
                    <div class="history-time">${timeStr} Â· ${method || 'ML'}</div>
                </div>
                <div class="history-conf">${conf > 0 ? (conf * 100).toFixed(0) + '%' : '--'}</div>
            `;

                list.insertBefore(item, list.firstChild);
            }

            function updateTime() {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                $('duration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            function start() {
                if (!modelsLoaded) {
                    alert('Models are still loading. Please wait.');
                    return;
                }

                video = $('webcam');
                canvas = $('canvas');
                ctx = canvas.getContext('2d');
                canvas.width = 640;
                canvas.height = 480;

                landmarkCanvas = $('landmarkCanvas');
                landmarkCtx = landmarkCanvas.getContext('2d', { willReadFrequently: true });
                const container = landmarkCanvas.parentElement;
                landmarkCanvas.width = container.offsetWidth;
                landmarkCanvas.height = container.offsetHeight;

                // Initialize MediaPipe Hands
                hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/${file}`
                });

                // OPTIMIZED MediaPipe settings for better performance
                // modelComplexity: 0 = Lite (faster, less accurate)
                // modelComplexity: 1 = Full (slower, more accurate)
                // Using 0 for better performance - accuracy is maintained by our FSM
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,           // OPTIMIZED: Use lite model (saves ~40% CPU)
                    minDetectionConfidence: 0.6,
                    minTrackingConfidence: 0.5    // Slightly lower for better tracking continuity
                });

                hands.onResults(onResults);

                // Initialize camera with optimized frame rate
                camera = new Camera(video, {
                    onFrame: async () => {
                        if (running) {
                            await hands.send({ image: video });
                        }
                    },
                    width: 640,
                    height: 480,
                    facingMode: 'user'
                });

                camera.start().then(() => {
                    $('placeholder').style.display = 'none';
                    $('startBtn').style.display = 'none';
                    $('stopBtn').style.display = 'inline-flex';
                    $('mudraName').style.display = 'block';
                    running = true;
                    startTime = Date.now();
                    sessionTimer = setInterval(updateTime, 1000);

                    // Reset FSM
                    if (mudraFSM) mudraFSM.reset();
                }).catch((err) => {
                    alert('Could not access camera. Please ensure camera permissions are granted.');
                });
            }

            function stop() {
                running = false;
                clearInterval(sessionTimer);

                if (camera) {
                    camera.stop();
                }

                $('placeholder').style.display = 'flex';
                $('startBtn').style.display = 'inline-flex';
                $('stopBtn').style.display = 'none';
                $('mudraName').style.display = 'none';

                if (landmarkCtx) {
                    landmarkCtx.clearRect(0, 0, landmarkCanvas.width, landmarkCanvas.height);
                }
            }

            function reset() {
                stop();
                uniqueMap = {};
                lastMudra = null;
                prevLandmarks = null;
                $('uniqueCount').textContent = '0';
                $('duration').textContent = '0:00';
                $('historyList').innerHTML = '<div class="empty-state">No mudras detected yet</div>';
                $('currentName').textContent = '--';
                $('currentMeaning').textContent = 'Waiting for detection';

                if (mudraFSM) {
                    mudraFSM = new window.MudraDetection.MudraFSM();
                }
            }

            // Event listeners
            $('startBtn').addEventListener('click', start);
            $('stopBtn').addEventListener('click', stop);
            $('resetBtn').addEventListener('click', reset);

            // Initialize on page load
            window.addEventListener('load', initializeModels);
        })();
    </script>

    <!-- Chatbot Widget -->
    <script src="../js/chat-widget.js"></script>
</body>

</html>